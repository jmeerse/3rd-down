---
title: "3rd_down"
output: html_document
date: '2022-06-29'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(nflfastR)
library(nflreadr)
library(tidyverse)
library(ggimage)
library(ggrepel)

options(scipen = 999)

```

```{r data and cleaning}
pbp <- load_pbp(2018:2021)

pbp <- pbp[!is.na(pbp$yards_gained), ]
pbp <- pbp[!is.na(pbp$down), ]

runpass <- pbp %>% filter(play_type == "run" | play_type == "pass")

remove(pbp)

runpass <- runpass %>% filter(fumble_lost == 0)

ave_run <- runpass %>% group_by(posteam, down) %>% 
  filter(play_type == "run") %>% 
  summarise(averun = mean(yards_gained, na.rm = TRUE),
            n_run = n()) %>% 
  ungroup()

ave_pass <- runpass %>% group_by(posteam, down) %>% 
  filter(play_type == "pass") %>% 
  summarise(avepass = mean(yards_gained, na.rm = TRUE),
            n_pass = n()) %>% 
  ungroup()

avs <- left_join(ave_pass, ave_run, by = c("posteam", "down"))

avs <- left_join(avs, teams_colors_logos, by = c("posteam" = "team_abbr") )







```

graphs

```{r graphs}
library(hrbrthemes) #gives lots of font error/warnings

runpass %>% filter(play_type == "run") %>% 
  ggplot(aes(x = yards_gained, y = down, group = down)) + 
  geom_boxplot() #boxplot of runs by downs

runpass %>% filter(play_type == "pass") %>% 
  ggplot(aes(x = yards_gained, y = as.factor(down))) + 
  geom_boxplot() +
  stat_summary(fun = "mean", geom="point", color = "red") +
  labs(title = "Ave Passing Yards by Down") #boxplot of runs by downs


avs %>% ggplot(aes(x = averun, y = avepass, shape = as.factor(down), color = as.factor(down))) +
  geom_point() + theme_light() #dotplot, shape and color by down



avs %>% ggplot(aes(x = averun, y = avepass)) +
  geom_image(aes(image = team_logo_wikipedia), size = 0.05) +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(~ down)

avs %>% ggplot(aes(x = averun, y = avepass)) +
  geom_image(aes(image = team_logo_wikipedia), size = 0.05) +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(~ down)

runpass %>% filter(down == 3) %>% 
  ggplot(aes(yards_gained, group = play_type, color = play_type)) +
  geom_boxplot() + facet_wrap(~ series_success)
```

```{r summary stats}
runpass %>% group_by(play_type) %>% summarise(mean = mean(yards_gained), n = n()) #ave yds gained by play type

#not including 4th down
runpass %>% filter(down <= 3) %>% 
  group_by(play_type) %>% 
  summarise(mean = mean(yards_gained), n = n()) 


#epa by play type
eparp <- runpass %>% 
  group_by(play_type, down) %>% 
  summarise(mean_epa = mean(epa, na.rm = TRUE), 
            success = mean(series_success, na.rm = TRUE), 
            meanyds = mean(yards_gained, na.rm = TRUE),
            meantogo = mean(ydstogo, na.rm = TRUE),
            n = n()) %>% 
  ungroup()

eparp


#qbs on 3rd down passing
qbs_3rd <- runpass %>% group_by(passer_player_name, posteam) %>% 
  filter(down == 3 & passer_player_name != "NA") %>% 
  summarise(mean_epa = mean(epa, na.rm = TRUE),
            mean_ydstogo = mean(ydstogo, na.rm = TRUE),
            mean_ydsgain = mean(yards_gained, na.rm = TRUE),
            n = n()
            ) %>% 
  filter(n > 300) %>%
  ungroup()

qbs_3rd <- qbs_3rd %>% left_join(teams_colors_logos, by = c("posteam" = "team_abbr"))

qbs_3rd %>% ggplot(aes(x = mean_ydstogo, y = mean_epa)) +
  geom_image(aes(image = team_logo_wikipedia), size = 0.07 ) +
  geom_hline(yintercept = -0.0420, color = "red", linetype = "dashed", alpha=0.5) +
  geom_vline(xintercept = 7.67, color = "red", linetype = "dashed", alpha=0.5) +
  labs(x = "Average Yards to Go",
       y = "Average EPA, Passing",
       title = "QB Performance on 3rd Down Passes",
       subtitle = "2018 - 2021, min 300 plays",
       caption = "@jmeerse   data: nflfastR") +
  geom_label(x = qbs_3rd$mean_ydstogo[20] + .2, 
             y = qbs_3rd$mean_epa[20],
             size = 2.5,
             label = qbs_3rd$passer_player_name[20],
             )



```

